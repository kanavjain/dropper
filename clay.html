<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SVG Filters Music Visualizer with Enhanced CSS</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #111, #333);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }

        #visualizer {
            width: 80vw;
            height: 80vh;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
            background: rgba(0, 0, 0, 0.6);
        }

        svg {
            width: 100%;
            height: 100%;
            position: absolute;
        }

        .bar {
            fill: url(#gradient);
            transition: all 0.1s ease-out; /* Smooth height transition */
        }

        @keyframes gradientAnimation {
            0% { stop-color: rgb(255, 0, 0); }
            25% { stop-color: rgb(255, 255, 0); }
            50% { stop-color: rgb(0, 255, 0); }
            75% { stop-color: rgb(0, 0, 255); }
            100% { stop-color: rgb(255, 0, 255); }
        }

        @keyframes backgroundPulse {
            0% { background: linear-gradient(135deg, #111, #333); }
            50% { background: linear-gradient(135deg, #333, #111); }
            100% { background: linear-gradient(135deg, #111, #333); }
        }

        body {
            animation: backgroundPulse 10s infinite alternate;
        }
    </style>
</head>
<body>
    <div id="visualizer"></div>

    <!-- SVG Filters Definition -->
    <svg id="filters" xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <defs>
            <!-- Gradient for the bars -->
            <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-opacity:1">
                    <animate attributeName="stop-color" values="rgb(255,0,0);rgb(255,255,0);rgb(0,255,0);rgb(0,0,255);rgb(255,0,255);rgb(255,0,0)" dur="8s" repeatCount="indefinite"/>
                </stop>
                <stop offset="100%" style="stop-opacity:1">
                    <animate attributeName="stop-color" values="rgb(0,0,255);rgb(0,255,255);rgb(255,0,0);rgb(255,255,0);rgb(0,255,0);rgb(0,0,255)" dur="8s" repeatCount="indefinite"/>
                </stop>
            </linearGradient>

            <!-- Glow Effect -->
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" />
                <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                </feMerge>
            </filter>

            <!-- Color Shift Filter -->
            <filter id="colorShift">
                <feColorMatrix type="hueRotate" values="0">
                    <animate attributeName="values" from="0" to="360" dur="10s" repeatCount="indefinite" />
                </feColorMatrix>
            </filter>
        </defs>
    </svg>

    <script>
        // Set up the SVG visualization
        const visualizer = document.getElementById('visualizer');
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, 'svg');
        visualizer.appendChild(svg);

        // Number of bars in the visualizer
        const numBars = 64;
        const bars = [];

        // Create the bars
        for (let i = 0; i < numBars; i++) {
            const rect = document.createElementNS(svgNS, 'rect');
            rect.setAttribute('class', 'bar');
            rect.setAttribute('x', (i / numBars) * 100 + '%');
            rect.setAttribute('y', '50%');
            rect.setAttribute('width', (1 / numBars) * 90 + '%'); // Adjust width for spacing
            rect.setAttribute('height', '0%');
            rect.setAttribute('filter', 'url(#glow)');

            svg.appendChild(rect);
            bars.push(rect);
        }

        // Audio setup
        let audioContext;
        let analyser;
        let dataArray;

        // Start the audio processing
        function startVisualizer() {
            // Create audio context
            audioContext = new (window.AudioContext || window.webkitAudioContext)();

            // Create analyser node
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;

            // Create data array
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Get audio input
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(analyser);
                        visualize();
                    })
                    .catch(function(err) {
                        alert('Microphone access denied or not available.');
                        console.error('Error accessing microphone: ' + err);
                    });
            } else {
                alert('getUserMedia not supported in this browser.');
                console.error('getUserMedia not supported in this browser.');
            }
        }

        // Visualization loop
        function visualize() {
            requestAnimationFrame(visualize);

            analyser.getByteFrequencyData(dataArray);

            for (let i = 0; i < numBars; i++) {
                const value = dataArray[i];
                const percent = value / 255;
                const height = percent * 100;
                const y = 100 - height;

                bars[i].setAttribute('height', height + '%');
                bars[i].setAttribute('y', y + '%');
            }
        }

        // Apply SVG filters to the visualizer
        svg.setAttribute('filter', 'url(#colorShift)');

        // Start the visualizer when the page loads
        window.addEventListener('load', startVisualizer);
    </script>
</body>
</html>
