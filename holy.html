<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Immersive Audio Visualizer</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: black; touch-action: none; }
        canvas { display: block; }
        #startButton, #infoButton {
            position: absolute;
            padding: 15px 30px;
            font-size: 18px;
            background-color: rgba(76, 175, 80, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #startButton:hover, #infoButton:hover {
            background-color: rgba(76, 175, 80, 1);
        }
        #startButton {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #infoButton {
            top: 10px;
            right: 10px;
        }
        #infoPanel {
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <button id="startButton">Start Visualizer</button>
    <button id="infoButton">i</button>
    <div id="infoPanel">
        <p>Touch and drag to rotate</p>
        <p>Pinch to zoom</p>
        <p>Double tap to change shape</p>
    </div>
    <script type="module">
        import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.169.0/three.module.min.js';

        let scene, camera, renderer, visualizer, audioContext, audioAnalyser, dataArray;
        let isAudioInitialized = false;
        let lastTap = 0;
        let zoomDistance = 5;
        const shapes = ['sphere', 'cube', 'torus'];
        let currentShape = 0;

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            visualizer = createVisualizer();
            scene.add(visualizer);

            addLighting();

            camera.position.z = zoomDistance;

            window.addEventListener('resize', onWindowResize);
            document.addEventListener('touchstart', onTouchStart, { passive: false });
            document.addEventListener('touchmove', onTouchMove, { passive: false });
            document.addEventListener('touchend', onTouchEnd, { passive: false });

            document.getElementById('infoButton').addEventListener('click', toggleInfoPanel);
        }

        function addLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
        }

        function createVisualizer() {
            const geometry = createGeometry();
            const material = new THREE.MeshPhongMaterial({
                color: 0xffffff,
                emissive: 0x222222,
                shininess: 100,
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });
            return new THREE.Mesh(geometry, material);
        }

        function createGeometry() {
            switch(shapes[currentShape]) {
                case 'cube':
                    return new THREE.BoxGeometry(3, 3, 3, 32, 32, 32);
                case 'torus':
                    return new THREE.TorusGeometry(2, 0.5, 32, 100);
                case 'sphere':
                default:
                    return new THREE.SphereGeometry(2, 32, 32);
            }
        }

        async function setupAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                audioAnalyser = audioContext.createAnalyser();
                audioAnalyser.fftSize = 256;
                source.connect(audioAnalyser);
                dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
                isAudioInitialized = true;
            } catch (err) {
                console.error('Error accessing microphone:', err);
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isAudioInitialized) {
                audioAnalyser.getByteFrequencyData(dataArray);
                updateVisualizer();
            }

            renderer.render(scene, camera);
        }

        function updateVisualizer() {
            const averageFrequency = getAverageFrequency();
            const scale = 1 + averageFrequency * 0.2;
            visualizer.scale.set(scale, scale, scale);

            const hue = (Date.now() % 10000) / 10000;
            const color = new THREE.Color().setHSL(hue, 1, 0.5);
            visualizer.material.color = color;
            visualizer.material.emissive.setHSL(hue, 1, 0.2);

            visualizer.rotation.x += 0.001;
            visualizer.rotation.y += 0.002;
        }

        function getAverageFrequency() {
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            return sum / dataArray.length / 255;
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onTouchStart(event) {
            event.preventDefault();
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                changeShape();
            }
            lastTap = currentTime;
        }

        function onTouchMove(event) {
            event.preventDefault();
            if (event.touches.length === 1) {
                const touch = event.touches[0];
                visualizer.rotation.y = (touch.clientX / window.innerWidth) * Math.PI * 2;
                visualizer.rotation.x = (touch.clientY / window.innerHeight) * Math.PI;
            } else if (event.touches.length === 2) {
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                const distance = Math.hypot(
                    touch1.pageX - touch2.pageX,
                    touch1.pageY - touch2.pageY
                );
                zoomDistance = Math.max(2, Math.min(10, 10 - distance / 50));
                camera.position.z = zoomDistance;
            }
        }

        function onTouchEnd(event) {
            event.preventDefault();
        }

        function changeShape() {
            currentShape = (currentShape + 1) % shapes.length;
            scene.remove(visualizer);
            visualizer = createVisualizer();
            scene.add(visualizer);
        }

        function toggleInfoPanel() {
            const infoPanel = document.getElementById('infoPanel');
            infoPanel.style.display = infoPanel.style.display === 'none' ? 'block' : 'none';
        }

        document.getElementById('startButton').addEventListener('click', () => {
            document.getElementById('startButton').style.display = 'none';
            init();
            setupAudio().then(() => animate());
        });
    </script>
</body>
</html>
