<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Legible Visualizer</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    button {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 20px;
      font-size: 16px;
      z-index: 1000;
    }
    .error-message {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: red;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <button id="start-button">Start Microphone</button>
  <div class="error-message" id="error-message"></div>

  <script type="module">
    import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/0.169.0/three.module.min.js';

    let audioContext;
    let analyser;
    let dataArray;
    let micStream;
    let isMicrophoneEnabled = false;

    const startButton = document.getElementById('start-button');
    const errorMessage = document.getElementById('error-message');
    startButton.addEventListener('click', startMicAudio);

    async function startMicAudio() {
      try {
        // Request microphone access
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        // Create media stream source from microphone
        micStream = audioContext.createMediaStreamSource(stream);
        micStream.connect(analyser);
        isMicrophoneEnabled = true;

        // Hide the start button after microphone access is granted
        startButton.style.display = 'none';
        errorMessage.innerText = '';  // Clear any previous errors

        // Start the rendering process
        render();
      } catch (err) {
        errorMessage.innerText = 'Microphone access denied. Please check your browser permissions.';
        console.error('Microphone access error:', err);
      }
    }

    // Function to get the beat intensity from microphone input
    function getBeat() {
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        sum += dataArray[i];
      }
      return sum / dataArray.length;  // Return average frequency
    }

    // Initialize Three.js scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Resize renderer on window resize (mobile-friendly)
    window.addEventListener('resize', () => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    });

    const fontLoader = new THREE.FontLoader();
    let textMeshes = [];
    let font;
    let revealedWords = []; // Track which words are revealed

    fontLoader.load('https://threejs.org/examples/fonts/helvetiker_regular.typeface.json', function (loadedFont) {
      font = loadedFont;
      createTextMeshes();
    });

    // Full text to render
    const fullText = 'This is an example visualizer where words react to the microphone input.';
    const words = fullText.split(' ');

    // Split text into words and create text meshes
    function createTextMeshes() {
      words.forEach((word, index) => {
        // Create gibberish for each word, starting with gibberish
        let geometry = new THREE.TextGeometry(generateGibberish(word.length), {
          font: font,
          size: 0.5,
          height: 0.05,
        });

        const material = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.2 });
        const mesh = new THREE.Mesh(geometry, material);

        // Position words randomly at first
        mesh.position.set(
          Math.random() * 10 - 5, // Random x position
          Math.random() * 5 - 2.5, // Random y position
          Math.random() * 5 - 10   // Random z position
        );
        textMeshes.push(mesh);
        scene.add(mesh);
      });

      camera.position.z = 15; // Position camera to see all words
    }

    // Function to generate gibberish
    function generateGibberish(length) {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    // Function to update text mesh behavior based on microphone input
    function updateTextMeshes(beatStrength) {
      textMeshes.forEach((mesh, index) => {
        // Move words based on beat intensity
        mesh.position.y += Math.sin(Date.now() * 0.002) * beatStrength * 0.01;
        mesh.rotation.z += Math.sin(Date.now() * 0.001) * beatStrength * 0.002;

        // Gradually reveal words as beatStrength increases
        if (beatStrength > 50 && !revealedWords[index]) {
          // Reveal word based on beat strength
          const word = words[index];
          let geometry = new THREE.TextGeometry(word, {
            font: font,
            size: 0.5,
            height: 0.05,
          });
          mesh.geometry.dispose(); // Remove old geometry
          mesh.geometry = geometry; // Set new legible geometry
          mesh.material.opacity = 1; // Make fully visible
          revealedWords[index] = true; // Mark word as revealed
        }
      });
    }

    // Render loop
    function render() {
      requestAnimationFrame(render);

      if (isMicrophoneEnabled) {
        const beatStrength = getBeat();
        updateTextMeshes(beatStrength);
      }

      renderer.render(scene, camera);
    }

    // Fallback for older browsers or issues
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      errorMessage.innerText = 'Your browser does not support microphone access. Please update to a modern browser.';
    }
  </script>
</body>
</html>
