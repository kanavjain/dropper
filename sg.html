<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unicode Optimized Visualizer</title>
    <style>
        html, body {
            margin: 0;
            overflow: hidden;
            height: 100%;
            background: linear-gradient(to bottom, #1e3c72, #2a5298, #000); /* Deep blue gradient for sky */
        }
        canvas {
            display: block;
        }
        .unicode-element {
            position: absolute;
            font-size: 30px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Include Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, clock;
        let analyser, frequencyData;
        const cameraSpeedBase = 10;
        let cameraSpeed = cameraSpeedBase;
        const unicodeElements = [];
        let lastEmojiCreationTime = 0;

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1e3c72, 50, 400); // Add fog for depth perception

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 2, 10);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Initialize clock
            clock = new THREE.Clock();

            // Setup audio input
            setupAudio();

            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function setupAudio() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('getUserMedia not supported on your browser!');
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    source.connect(analyser);
                    frequencyData = new Uint8Array(analyser.frequencyBinCount);
                })
                .catch(function (err) {
                    alert('Could not access microphone: ' + err.message + '. Please try again.');
                    console.error('The following getUserMedia error occurred: ', err);
                });
        }

        function updateUnicodeWithSound() {
            if (analyser) {
                analyser.getByteFrequencyData(frequencyData);
                const bass = getFrequencyRangeValue(0, 10);

                // Adjust camera speed based on bass frequencies
                cameraSpeed = cameraSpeedBase + bass / 50;

                // Create new Unicode element in response to bass frequencies
                if (bass > 150 && Date.now() - lastEmojiCreationTime > 300) {
                    createUnicodeElement();
                    lastEmojiCreationTime = Date.now();
                }
            }
        }

        function createUnicodeElement() {
            const unicodeChars = ['🌲', '🚗', '🚙', '🏢', '🌵', '🚧', '🌟', '🚓', '🚑', '🚕', '🚒', '🦄', '🐘'];
            const char = unicodeChars[Math.floor(Math.random() * unicodeChars.length)];
            const unicodeElement = document.createElement('div');
            unicodeElement.textContent = char;
            unicodeElement.className = 'unicode-element';
            unicodeElement.style.fontSize = `${Math.random() * 40 + 20}px`;
            unicodeElement.style.left = `${Math.random() * window.innerWidth}px`;
            unicodeElement.style.top = `${Math.random() * window.innerHeight / 2}px`;
            document.body.appendChild(unicodeElement);

            // Animate the element (move it upward and remove it after it leaves the view)
            const moveUp = () => {
                const topPos = parseFloat(unicodeElement.style.top);
                if (topPos > -50) {
                    unicodeElement.style.top = `${topPos - 2}px`;
                    requestAnimationFrame(moveUp);
                } else {
                    unicodeElement.remove();
                    unicodeElements.splice(unicodeElements.indexOf(unicodeElement), 1);
                }
            };
            moveUp();

            unicodeElements.push(unicodeElement);
        }

        function getFrequencyRangeValue(start, end) {
            const slice = frequencyData.slice(start, end);
            const sum = slice.reduce((a, b) => a + b, 0);
            return sum / slice.length;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Move camera forward
            camera.position.z -= delta * cameraSpeed;
            camera.position.y = 2; // Keep camera steady

            // Update Unicode elements based on sound input
            updateUnicodeWithSound();

            // Render the scene
            renderer.render(scene, camera);
        }

        // Initialize the visualizer
        init();
    </script>
</body>
</html>
