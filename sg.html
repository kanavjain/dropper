<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Star Guitar Inspired Visualizer - Car Ride Experience</title>
    <style>
        html, body {
            margin: 0;
            overflow: hidden;
            height: 100%;
            background: linear-gradient(to bottom, #1e3c72, #2a5298, #000); /* Deep blue gradient for sky */
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Include Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let clock;
        let analyser, frequencyData;
        const scenery = [];
        const carElements = [];
        const cameraSpeed = 15;

        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1e3c72, 50, 400); // Add deep blue fog for sky depth

            // Camera setup
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 2, 10); // Adjusted position to create a car-like perspective
            camera.rotation.y = 0.05; // Slightly rotate to the right to simulate being in a car

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // Lighting setup
            const ambientLight = new THREE.AmbientLight(0xe0e0e0, 1.0);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 100, -100);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Initialize scene elements
            createRoad();
            createStars();

            // Initialize clock
            clock = new THREE.Clock();

            // Setup audio
            setupAudio();

            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function createRoad() {
            // Create road
            const roadGeometry = new THREE.PlaneGeometry(2000, 20);
            const roadMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const road = new THREE.Mesh(roadGeometry, roadMaterial);
            road.rotation.x = -Math.PI / 2;
            road.position.y = 0;
            scene.add(road);
        }

        function createStars() {
            // Add starry sky effect
            const starGeometry = new THREE.BufferGeometry();
            const starMaterial = new THREE.PointsMaterial({ color: 0xffffff });

            const starVertices = [];
            for (let i = 0; i < 1000; i++) {
                starVertices.push((Math.random() - 0.5) * 2000);
                starVertices.push(Math.random() * 800 - 100);
                starVertices.push((Math.random() - 0.5) * 2000);
            }
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));

            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        }

        function setupAudio() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('getUserMedia not supported on your browser!');
                return;
            }

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (stream) {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    source.connect(analyser);
                    frequencyData = new Uint8Array(analyser.frequencyBinCount);
                })
                .catch(function (err) {
                    alert('Could not access microphone: ' + err.message + '. Please try again.');
                    console.error('The following getUserMedia error occurred: ', err);
                });
        }

        function updateSceneryWithSound() {
            if (analyser) {
                analyser.getByteFrequencyData(frequencyData);
                const bass = getFrequencyRangeValue(0, 10);
                const mid = getFrequencyRangeValue(11, 40);
                const treble = getFrequencyRangeValue(41, 60);

                // Create trees/buildings in response to bass frequencies
                if (bass > 150) {
                    createTreeOrBuilding();
                }

                // Create cars in response to mid frequencies
                if (mid > 120) {
                    createCar();
                }
            }
        }

        function createTreeOrBuilding() {
            const isTree = Math.random() > 0.5;
            let geometry, material;

            if (isTree) {
                geometry = new THREE.ConeGeometry(2, 10, 16);
                material = new THREE.MeshLambertMaterial({ color: 0x228b22 });
            } else {
                geometry = new THREE.BoxGeometry(5, Math.random() * 20 + 10, 5);
                material = new THREE.MeshLambertMaterial({ color: 0x8b8b8b });
            }

            const element = new THREE.Mesh(geometry, material);
            element.position.set(Math.random() < 0.5 ? -20 : 20, geometry.parameters.height / 2, camera.position.z - 50);
            element.castShadow = true;
            scene.add(element);
            scenery.push(element);
        }

        function createCar() {
            const carGeometry = new THREE.BoxGeometry(4, 2, 8);
            const carMaterial = new THREE.MeshLambertMaterial({ color: new THREE.Color(`hsl(${Math.random() * 360}, 70%, 50%)`) });
            const car = new THREE.Mesh(carGeometry, carMaterial);
            car.position.set(Math.random() < 0.5 ? -2 : 2, 1, camera.position.z - 50);
            car.castShadow = true;
            scene.add(car);
            carElements.push(car);
        }

        function getFrequencyRangeValue(start, end) {
            const slice = frequencyData.slice(start, end);
            const sum = slice.reduce((a, b) => a + b, 0);
            return sum / slice.length;
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Move the camera forward
            camera.position.z -= delta * cameraSpeed;
            camera.position.y = 2; // Keep the camera above the road

            // Update scenery with sound
            updateSceneryWithSound();

            // Move scenery elements
            scenery.forEach(obj => {
                obj.position.z += delta * cameraSpeed;
                if (obj.position.z > camera.position.z + 100) {
                    scene.remove(obj);
                    scenery.splice(scenery.indexOf(obj), 1); // Remove from array when out of view
                }
            });

            // Move cars on the road
            carElements.forEach(car => {
                car.position.z += delta * cameraSpeed * 1.5;
                if (car.position.z > camera.position.z + 50) {
                    scene.remove(car);
                    carElements.splice(carElements.indexOf(car), 1);
                }
            });

            renderer.render(scene, camera);
        }

        // Initialize the visualizer
        init();
    </script>
</body>
</html>
