<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Interactive Spectrograph Music Visualizer with Pattern Recognition</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: black;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            color: #ffffff;
            white-space: pre;
            line-height: 1;
        }
        #error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #ff0000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r169/three.min.js"></script>
</head>
<body>
    <div id="error-message" style="display: none;"></div>
    <canvas id="glCanvas"></canvas>
    <div id="asciiCanvas"></div>
    <script type="module">
        import PatternRecognizer from './assets/js/utils/patternRecognition.js';
        import { applyAudioRotation, applyAudioScale } from './assets/js/utils/animation-utils.js';
        import { initAudio, getFrequencyData } from './assets/js/utils/audio-handler.js';

        const canvas = document.getElementById("glCanvas");
        const asciiCanvas = document.getElementById("asciiCanvas");
        let scene, camera, renderer, cube;

        let analyser;
        let patternRecognizer;
        let audioDataArray = [];
        const words = ["dream", "light", "pulse", "wave", "echo", "flow", "rise", "fall", "beat", "harmony"];

        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;

            renderer = new THREE.WebGLRenderer({ canvas: canvas });
            renderer.setSize(window.innerWidth, window.innerHeight);

            const geometry = new THREE.BoxGeometry();
            const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
            cube = new THREE.Mesh(geometry, material);
            scene.add(cube);

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        async function setupAudio() {
            try {
                const audioData = await initAudio();
                analyser = audioData.analyser;
                audioDataArray = audioData.dataArray;
                patternRecognizer = new PatternRecognizer(analyser);
                getAudioData();
            } catch (err) {
                showError('Unable to access the microphone. Please allow microphone permissions and reload the page.');
                console.error("Error capturing audio: ", err);
            }
        }

        function getAudioData() {
            requestAnimationFrame(getAudioData);
            if (analyser) {
                getFrequencyData(analyser);
                const average = audioDataArray.reduce((sum, value) => sum + value, 0) / audioDataArray.length;
                patternRecognizer.updatePatternBuffer();
                const detectedPattern = patternRecognizer.detectPattern();
                updateAsciiVisualizer(audioDataArray, detectedPattern, average);
                animateCube(audioDataArray);
            }
        }

        function animateCube(dataArray) {
            const avgFrequency = dataArray.reduce((acc, val) => acc + val, 0) / dataArray.length;
            applyAudioRotation(cube, dataArray, 0.05);
            applyAudioScale(cube, dataArray, 50);
            if (avgFrequency > 200) {
                cube.material.color.setHex(0xff0000); // Change color based on audio intensity
            } else {
                cube.material.color.setHex(0x00ff00);
            }
            renderer.render(scene, camera);
        }

        function updateAsciiVisualizer(dataArray, detectedPattern, average) {
            asciiCanvas.textContent = "";
            const chars = [" ", "░", "▒", "▓", "#", "█", "■", "▲", "◆", "@", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"]; // Random Unicode characters and letters
            const width = 64;
            const height = 16;
            const barWidth = Math.floor(dataArray.length / width);
            const wordThreshold = 180; // Threshold intensity for words to appear

            for (let y = 0; y < height; y++) {
                let line = "";
                for (let x = 0; x < width; x++) {
                    const index = Math.min(x * barWidth, dataArray.length - 1);
                    const value = dataArray[index];
                    let char;

                    if (detectedPattern && value > wordThreshold) {
                        // Insert a random word from the words list based on the average intensity
                        char = words[Math.floor(Math.random() * words.length)];
                    } else {
                        // Use a random Unicode character or letter
                        const charIndex = Math.floor((value / 255) * (chars.length - 1));
                        char = chars[charIndex];
                    }

                    line += char + " "; // Add spacing for better legibility
                }
                asciiCanvas.textContent += line + "\n";
            }
        }

        initThreeJS();
        setupAudio();
    </script>
</body>
</html>
